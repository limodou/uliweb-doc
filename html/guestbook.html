

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>迷你留言板 &mdash; Uliweb Documentation 0.1.4 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.1.4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/translations.js"></script>
    <link rel="top" title="Uliweb Documentation 0.1.4 documentation" href="index.html" />
    <link rel="next" title="Sina Application Engine部署及开发指南" href="sae.html" />
    <link rel="prev" title="Hello, Uliweb" href="hello_uliweb.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="总目录"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="sae.html" title="Sina Application Engine部署及开发指南"
             accesskey="N">下一页</a> |</li>
        <li class="right" >
          <a href="hello_uliweb.html" title="Hello, Uliweb"
             accesskey="P">上一页</a> |</li>
        <li><a href="index.html">Uliweb Documentation 0.1.4 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="id1">
<h1>迷你留言板<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h1>
<p>也许你已经学过了 <a class="reference external" href="hello_uliweb.html">Hello, Uliweb</a> 这篇教程，对Uliweb已经有了一个感性的
认识，那么好，现在让我们进入数据库的世界，看一看如何使用简单的数据库。</p>
<div class="section" id="id2">
<h2>准备<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>在 uliweb-tests 项目中已经有完整的GuestBook的源代码，你可以从它里面检出:</p>
<div class="highlight-python"><pre>svn checkout http://uliweb-tests.googlecode.com/svn/trunk/guestbook guestbook
cd guestbook
uliweb runserver</pre>
</div>
<p>然后在浏览器输入 <a class="reference external" href="http://localhost:8000/">http://localhost:8000/</a> 这样就可以看到了。目前缺省是使用
sqlite3。如果你安装了python 2.5它已经是内置的。否则要安装相应的数据库和Python的绑定模
块。目前Uliweb使用 <a class="reference external" href="http://www.sqlalchemy.org">SqlAlchemy</a> 作为数据库底层驱动，
它支持多种数据库，如：mysql, sqlite, postgresql, 等。</p>
<p>好了，源码准备好了，下一步，准备开发环境。</p>
</div>
<div class="section" id="id3">
<h2>创建工程<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<p>建议在一个空目录下开始你的工作，例如:</p>
<div class="highlight-python"><pre>uliweb makeproject guestbook</pre>
</div>
</div>
<div class="section" id="app">
<h2>创建APP<a class="headerlink" href="#app" title="永久链接至标题">¶</a></h2>
<p>进入前面创建的目录，然后使用 makeapp 建一个新的App。执行:</p>
<div class="highlight-python"><pre>cd guestbook
uliweb makeapp GuestBook</pre>
</div>
<p>这样就自动会在项目的apps目录下创建一个 <tt class="docutils literal"><span class="pre">GuestBook</span></tt> 的App。</p>
</div>
<div class="section" id="id4">
<h2>配置数据库<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h2>
<p>Uliweb中的数据库不是缺省生效的，因此你需要配置一下才可以使用。Uliweb虽然提供了自已的
ORM，但是你可以不使用它。Uliweb提供了插件机制，可以让你容易地在适当的时候执行初始化的工作。
打开 <tt class="docutils literal"><span class="pre">apps/GuestBook/settings.ini</span></tt> 文件，修改 <tt class="docutils literal"><span class="pre">INSTALLED_APPS</span></tt> 的内容为:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">&#39;GuestBook&#39;</span><span class="p">,</span>
    <span class="s">&#39;uliweb.contrib.orm&#39;</span><span class="p">,</span>
    <span class="p">]</span>
</pre></div>
</div>
<p>然后添加下面的内容:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">[</span><span class="n">ORM</span><span class="p">]</span>
<span class="n">CONNECTION</span> <span class="o">=</span> <span class="s">&#39;sqlite:///guestbook.db&#39;</span>
</pre></div>
</div>
<p>所以 <tt class="docutils literal"><span class="pre">settings.ini</span></tt> 将看上去象:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">[</span><span class="n">GLOBAL</span><span class="p">]</span>
<span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">True</span>

<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">&#39;GuestBook&#39;</span><span class="p">,</span>
    <span class="s">&#39;uliweb.contrib.orm&#39;</span><span class="p">,</span>
    <span class="p">]</span>

<span class="p">[</span><span class="n">ORM</span><span class="p">]</span>
<span class="n">CONNECTION</span> <span class="o">=</span> <span class="s">&#39;sqlite:///guestbook.db&#39;</span>
</pre></div>
</div>
<p>ORM.CONNECTION 是ORM的连联字符串，它和SQLAlchemy包使用的一样。通常的格式看上去象:</p>
<div class="highlight-python"><pre>provider://username:password@localhost:port/dbname?argu1=value1&amp;argu2=value2</pre>
</div>
<p>对于Sqlite，连接信息有些不同:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">sqlite_db</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s">&#39;sqlite:////absolute/path/to/database.txt&#39;</span><span class="p">)</span>
<span class="n">sqlite_db</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s">&#39;sqlite:///d:/absolute/path/to/database.txt&#39;</span><span class="p">)</span>
<span class="n">sqlite_db</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s">&#39;sqlite:///relative/path/to/database.txt&#39;</span><span class="p">)</span>
<span class="n">sqlite_db</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s">&#39;sqlite://&#39;</span><span class="p">)</span>  <span class="c"># in-memory database</span>
<span class="n">sqlite_db</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s">&#39;sqlite://:memory:&#39;</span><span class="p">)</span>  <span class="c"># the same</span>
</pre></div>
</div>
<p>这里我们使用相对路径格式，所以 <tt class="docutils literal"><span class="pre">guestbook.db</span></tt> 将会在guestbook目录下被创建。</p>
</div>
<div class="section" id="id5">
<h2>模板环境的扩展<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h2>
<p>向 <tt class="docutils literal"><span class="pre">GuestBook/__init__.py</span></tt> 中添加:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">uliweb.core.dispatch</span> <span class="kn">import</span> <span class="n">bind</span>

<span class="nd">@bind</span><span class="p">(</span><span class="s">&#39;prepare_view_env&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">prepare_view_env</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">uliweb.utils.textconvert</span> <span class="kn">import</span> <span class="n">text2html</span>
    <span class="n">env</span><span class="p">[</span><span class="s">&#39;text2html&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">text2html</span>
</pre></div>
</div>
<p>这也是一个dispatch的使用示例，它将向模板的环境中注入一个新的函数 <tt class="docutils literal"><span class="pre">text2html</span></tt>,
这样你就可以在模板中直接使用text2html这个函数了。</p>
</div>
<div class="section" id="model">
<h2>准备Model<a class="headerlink" href="#model" title="永久链接至标题">¶</a></h2>
<p>在GuestBook目录下创建一个名为models.py的文件，内容为:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">uliweb.orm</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">class</span> <span class="nc">Note</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">CHAR</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">TEXT</span><span class="p">)</span>
    <span class="n">homepage</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
    <span class="n">datetime</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>很简单。</p>
<p>首先要从 uliweb.orm 中导入一些东西，这里是全部导入。</p>
<p>Uliorm在定义Model时支持两种定义方式：</p>
<ul class="simple">
<li>使用内部的Python类型，如：int, float, unicode, datetime.datetime, datetime.date,
datetime.time, decimal.Decimal, str, bool。另外还扩展了一些类型，如：BLOB, CHAR, TEXT, DECIMAL。
所以你在定义时只要使用Python的类型就好了。</li>
<li>然后就是象GAE一样的使用各种Property类，如：StringProperty, UnicodeProperty,
IntegerProperty, BlobProperty, BooleanProperty, DateProperty, DateTimeProperty,
TimeProperty, DecimalProperty, FloatProperty, TextProperty。</li>
</ul>
<p>一个Model需要从 <tt class="docutils literal"><span class="pre">Model</span></tt> 类派生。然后每个字段就是定义为类属性。Field()是一个函数，它将
会根据第一个参数来查找对应的属性类，因此:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Note</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">StringProperty</span><span class="p">()</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">TextProperty</span><span class="p">()</span>
    <span class="n">homepage</span> <span class="o">=</span> <span class="n">StringProperty</span><span class="p">()</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">StringProperty</span><span class="p">()</span>
    <span class="n">datetime</span> <span class="o">=</span> <span class="n">DateTimeProperty</span><span class="p">()</span>
</pre></div>
</div>
<p>每个字段还可以有一些属性，如常用的：</p>
<ul class="simple">
<li>default 缺省值</li>
<li>max_length 最大值</li>
<li>verbose_name 提示信息</li>
</ul>
<p>象CharProperty和StringProperty，需要有一个max_length属性，如果没有给出，缺省是30。</p>
<p>其它详细的说明可以在数据文档中查看。</p>
<div class="admonition note">
<p class="first admonition-title">注解</p>
<p class="last">在定义Model时，Uliorm会自动为你添加 <tt class="docutils literal"><span class="pre">id</span></tt> 字段的定义，它将是一个主键，这一
点与Django一样。</p>
</div>
</div>
<div class="section" id="id6">
<h2>静态文件处理<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h2>
<p>我们将在后面显示静态文件，现在只需要把 <tt class="docutils literal"><span class="pre">uliweb.contrib.staticfiles</span></tt> 添加到 <tt class="docutils literal"><span class="pre">INSTALLED_APPS</span></tt>
中就可以了。使用这个App，所有有效的app的static目录将被处理为静态目录，并且URL链接将添加
<tt class="docutils literal"><span class="pre">/static/</span></tt> 。现在 <tt class="docutils literal"><span class="pre">settings.ini</span></tt> 看上去象:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">[</span><span class="n">GLOBAL</span><span class="p">]</span>
<span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">True</span>

<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">&#39;GuestBook&#39;</span><span class="p">,</span>
    <span class="s">&#39;uliweb.contrib.orm&#39;</span><span class="p">,</span>
    <span class="s">&#39;uliweb.contrib.staticfiles&#39;</span><span class="p">,</span>
    <span class="p">]</span>

<span class="p">[</span><span class="n">ORM</span><span class="p">]</span>
<span class="n">CONNECTION</span> <span class="o">=</span> <span class="s">&#39;sqlite:///guestbook.db&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h2>显示留言<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h2>
<div class="section" id="guestbook-view">
<h3>增加guestbook()的View方法<a class="headerlink" href="#guestbook-view" title="永久链接至标题">¶</a></h3>
<p>打开GuestBook下的views.py文件，加入显示留言的处理代码:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">uliweb</span> <span class="kn">import</span> <span class="n">expose</span>
<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">Note</span>

<span class="nd">@expose</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">notes</span> <span class="o">=</span> <span class="n">Note</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Note</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">&#39;notes&#39;</span><span class="p">:</span><span class="n">notes</span><span class="p">}</span>
</pre></div>
</div>
<p>在开始的地方，我们导入了Node类。后面我们会用到。</p>
<p>然后使用expose()来定义URL为 <tt class="docutils literal"><span class="pre">/</span></tt> 。</p>
<p>然后是index()函数的定义。我们通过调用Node类的方法all()获得所有
记录。为了按时间倒序显示，使用order_by()方法，传入要按顺的字段。其中
<tt class="docutils literal"><span class="pre">Note.c.datetime.desc()</span></tt> 是Sqlalchemy的用法，表示倒序。</p>
<p>以下是一些简单的用法:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">notes</span> <span class="o">=</span> <span class="n">Note</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>                  <span class="c">#全部记录，不带条件</span>
<span class="n">note</span> <span class="o">=</span> <span class="n">Note</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>                  <span class="c">#获取id值为3的记录</span>
<span class="n">note</span> <span class="o">=</span> <span class="n">Note</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Note</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">username</span><span class="o">==</span><span class="s">&#39;limodou&#39;</span><span class="p">)</span> <span class="c">#获取username为limodou的记录</span>
</pre></div>
</div>
<p>然后我们返回一个字典，这样会自动使用Uliweb的模板套用机制，即自动调用与view方法
同名的模板文件。</p>
<div class="admonition note">
<p class="first admonition-title">注解</p>
<p>在Uliweb中每个访问的URL与View之间要通过定义来实现，如使用expose。它需要一个URL的
参数，然后在运行时，会把这个URL与所修饰的View方法进行对应，View方法将转化为：</p>
<blockquote>
<div>appname.viewmodule.functioname</div></blockquote>
<p class="last">的形式。它将是一个字符串。然后同时Uliweb还提供了一个反向函数url_for，它将用来根据
View方法的字符串形式和对应的参数来反向生成URL，可以用来生成链接，在后面的模板中我
们将看到。</p>
</div>
</div>
<div class="section" id="index-html">
<h3>定义index.html模板<a class="headerlink" href="#index-html" title="永久链接至标题">¶</a></h3>
<p>在GuestBook/templates目录下创建与View方法同名的模板，后缀为.html。在index.html中
添加如下内容:</p>
<div class="highlight-python"><pre>{{extend "base.html"}}
{{block content}}
&lt;h2&gt;&lt;a href="{{=url_for('GuestBook.views.new_comment')}}"&gt;New Comment&lt;/a&gt;&lt;/h2&gt;
{{for n in notes:}}
    &lt;div class="info"&gt;
    &lt;h3&gt;&lt;a href="{{= url_for('GuestBook.views.del_comment', id=n.id) }}"&gt;
    &lt;img src="{{= url_for_static('delete.gif') }}"/&gt;
    &lt;/a&gt; {{=n.username}} at {{=n.datetime.strftime('%Y/%m/%d %H:%M:%S')}} say:&lt;/h3&gt;
    &lt;p&gt;{{&lt;&lt;text2html(n.message)}}&lt;/p&gt;
    &lt;/div&gt;
{{pass}}
{{end}}</pre>
</div>
<p>第一行将从base.html模板进行继承。这里不想多说，只是要注意在base.html中有一个{{block content}}{{end}}
的定义，它表示子模板可以继承的块。你可以从Uliweb的源码中将base.html拷贝到你的目录下。</p>
<p>h2 标签将显示一个链接，它将用来调用添加留言的view函数。注意模板没有将显示与添加的
Form代码写在一起，因为那样代码比较多，同且如果用户输入出错，将再次显示所有的留言(因为这里
没有考虑分页)，这样处理比较慢，所以分成不同的处理了。</p>
<p><tt class="docutils literal"><span class="pre">{{for}}</span></tt> 是一个循环。记住Uliweb使用的是web2py的模板，不过进行了改造。所有在{{}}中的代码
可以是任意的Python代码，所以要注意符合Python的语法。因此后面的&#8217;:&#8217;是不能省的。Uliweb的模
板允许你将代码都写在{{}}中，但对于HTML代码因为不是Python代码，要使用 <tt class="docutils literal"><span class="pre">out.write(htmlcode)</span></tt>
这种代码来输出。也可以将Python代码写在{{}}中，而HTML代码放在括号外面，就象上面所做的。</p>
<p>在循环中对notes变量进行处理，然后显示一个删除的图形链接，用户信息和用户留言。</p>
<p>看到 <tt class="docutils literal"><span class="pre">{{&lt;&lt;text2html(n.message)}}</span></tt> 了吗？它使用了我们在GuestBook/__init__.py中定义的text2html函
数对文本进行格式化处理。</p>
<p><tt class="docutils literal"><span class="pre">{{pass}}</span></tt> 是必须的。在Uliweb模板中，不需要考虑缩近，但是需要在块语句结束时添加pass，表示缩
近结果。这样相当于把Python对缩近的严格要求进行了转换，非常方便。</p>
<p>好，在经过上面的工作后，显示留言的工作就完成了。但是目前还不能添加留言，下一步就让我们看如
何添加留言。</p>
<div class="admonition note">
<p class="first admonition-title">注解</p>
<p class="last">因为在base.html中和guestbook.html用到了一些css和图形文件，因此你可以从Uliweb的
GuestBook/static目录下将全部文件拷贝到你的目录下。</p>
</div>
</div>
</div>
<div class="section" id="id8">
<h2>增加留言<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h2>
<div class="section" id="new-comment-view">
<h3>增加new_comment()的View方法<a class="headerlink" href="#new-comment-view" title="永久链接至标题">¶</a></h3>
<p>在前面的模板中我们定义了增加留言的链接:</p>
<div class="highlight-python"><pre>&lt;a href="{{=url_for('%s.views.new_comment' % request.appname)}}"&gt;New Comment&lt;/a&gt;</pre>
</div>
<p>可以看出，我们使用了url_for来生成反向的链接。关于url_for在前面已经讲了，这里要注意的就是
函数名为new_comment，因此我们需要在views.py中生成这样的一个方法。</p>
<p>打开views.py，加入以下代码:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@expose</span><span class="p">(</span><span class="s">&#39;/new&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">new_comment</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">forms</span> <span class="kn">import</span> <span class="n">NoteForm</span>
    <span class="kn">import</span> <span class="nn">datetime</span>

    <span class="n">form</span> <span class="o">=</span> <span class="n">NoteForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;GET&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;form&#39;</span><span class="p">:</span><span class="n">form</span><span class="p">,</span> <span class="s">&#39;message&#39;</span><span class="p">:</span><span class="s">&#39;&#39;</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">Note</span><span class="p">(</span><span class="o">**</span><span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">n</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;There is something wrong! Please fix them.&quot;</span>
            <span class="k">return</span> <span class="p">{</span><span class="s">&#39;form&#39;</span><span class="p">:</span><span class="n">form</span><span class="p">,</span> <span class="s">&#39;message&#39;</span><span class="p">:</span><span class="n">message</span><span class="p">}</span>
</pre></div>
</div>
<p>可以看到链接是 <tt class="docutils literal"><span class="pre">/new</span></tt> 。</p>
<p>首先我们导入了NoteForm这个类。它是用来生成录入Form的类，并且可以用来对数据进行校验。一会儿会对它进行介绍。</p>
<p>然后创建form对象。</p>
<p>再根据request.method是GET还是POST来执行不同的操作。对于GET将显示一个空Form，对于POST
表示用户提交了数据，要进行处理。使用GET和POST可以在同一个链接下处理不同的动作，这是一种
约定，一般中读操作使用GET，写或修改操作使用POST。</p>
<p>在request.method为GET时，我们只是返回空的form对象和一个空的message变量。form.html()可
以返回一个空的HTML表单代码。而message将用来提示出错的信息。</p>
<p>在request.method为POST时， 首先调用 <tt class="docutils literal"><span class="pre">form.validate(request.values)</span></tt> 对数据进行校验。
它将返回一个二元的tuple。第一个参数表示成功还是出错，第二个为成功时将转换为Python格式后
的数据，失败时为出错信息。</p>
<p>当flag为True时，进行成功处理。一会我们可以看到在表单中并没有datetime字段，因为我们
手工添加一个值，表示留言提交的时间。然后通过 <tt class="docutils literal"><span class="pre">n</span> <span class="pre">=</span> <span class="pre">Note(**form.data)</span></tt> 来生成Note记录，但这里并没有提
交到数据库中，因此再执行一个 <tt class="docutils literal"><span class="pre">n.save()</span></tt> 来保存记录到数据库中。</p>
<p>然后执行完毕后，调用 <tt class="docutils literal"><span class="pre">return</span> <span class="pre">redirect</span></tt> 进行页面的跳转，跳回留言板的首页。这里又使用了url_for来反
向生成链接。</p>
<p>当flag为False时，进行出错处理。</p>
</div>
<div class="section" id="id9">
<h3>定义录入表单<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h3>
<p>为了与后台进行交互，让用户可以通过浏览器进行数据录入，需要使用HTML的form系列元素来定义
录入元素。对于有经验的Web开发者可以直接手写HTML代码，但是对于初学者很麻烦。并且你还要考虑
出错处理，数据格式转换的处理。因此许多框架都提供了生成表单的工具，Uliweb也不例外。Form模
块就是干这个用的。</p>
<p>在GuestBook目录下创建forms.py文件，然后添加以下代码:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">uliweb.form</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">class</span> <span class="nc">NoteForm</span><span class="p">(</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Message:&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Username:&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">homepage</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Homepage:&#39;</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Email:&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>这里我定义了4个字段，每个字段对应一种类型。象TextField
表示多行的文本编辑，StringField表示单行文本，你还可以使用象：HiddenField, SelectField,
FileField, IntField, PasswordField, RadioSelectField等字段类型。</p>
<p>也许你看到了，这其中有一些是带有类型的，如IntField，那么它将会转换为对应的Python数据类
型，同时当生成HTML代码时再转换回字符串。</p>
<p>每个Field类型可以定义若干的参数，如：</p>
<ul class="simple">
<li>label 用来显示一个标签</li>
<li>required 用来校验是否输入，即不允许为空</li>
<li>default 缺省值</li>
<li>validators 校验器</li>
</ul>
<p>很象Model的定义，但有所不同。</p>
</div>
<div class="section" id="new-comment-html">
<h3>编写new_comment.html模板文件<a class="headerlink" href="#new-comment-html" title="永久链接至标题">¶</a></h3>
<p>在GuestBook/templates下创建new_comment.html，然后添加以下内容:</p>
<div class="highlight-python"><pre>{{extend "base.html"}}
{{block content}}
{{if message:}}
    &lt;p class="warning"&gt;{{=message}}&lt;/p&gt;
{{pass}}
&lt;h1&gt;New Comment&lt;/h1&gt;
&lt;div class="form"&gt;
{{&lt;&lt;form}}
&lt;/div&gt;
{{end}}</pre>
</div>
<p>首先是 <tt class="docutils literal"><span class="pre">{{extend</span> <span class="pre">&quot;base.html&quot;}}</span></tt> 表示从base.html继承。</p>
<p>然后是一个 if 判断是否有message信息，如果有则显示。这里要注意if后面的&#8217;:&#8217;号。</p>
<p>然后显示form元素，这里使用了 <tt class="docutils literal"><span class="pre">{{&lt;&lt;</span> <span class="pre">form}}</span></tt> 。form是从View中传入的，而{{&lt;&lt;}}
可以对要输出的内容中的HTML标签 不进行转义处理。而 {{=variable}} 将对variable
变量的HTML标签进行转换。因此，如果你想输出原始的HTML文本，要使用{{&lt;&lt;}}来输出。</p>
<p>现在可以在浏览器中试一下了。</p>
</div>
</div>
<div class="section" id="id10">
<h2>删除留言<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h2>
<p>在前面guestbook.html中，我们在每条留言前定义了一个删除的图形链接，形式为:</p>
<div class="highlight-python"><pre>&lt;a href="{{= url_for('GuestBook.views.del_comment', id=n.id) }}"&gt;</pre>
</div>
<p>那么下面就让我们实现它。</p>
<p>打开GuestBook/views.py文件，然后添加:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@expose</span><span class="p">(</span><span class="s">&#39;/delete/&lt;id&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">del_comment</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">Note</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">n</span><span class="p">:</span>
        <span class="n">n</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">error</span><span class="p">(</span><span class="s">&quot;No such record [</span><span class="si">%s</span><span class="s">] existed&quot;</span> <span class="o">%</span> <span class="nb">id</span><span class="p">)</span>
</pre></div>
</div>
<p>删除很简单，首先通过 <tt class="docutils literal"><span class="pre">Note.get(int(id))</span></tt> 来得到对象，然后再调用对象的delete()
方法来删除。</p>
<div class="section" id="url">
<h3>URL参数定义<a class="headerlink" href="#url" title="永久链接至标题">¶</a></h3>
<p>请注意，这里expose使用了一个参数，即 <tt class="docutils literal"><span class="pre">&lt;id&gt;</span></tt> 形式。一旦在expose中的url定义
中有 <tt class="docutils literal"><span class="pre">&lt;type:para&gt;</span></tt> 的形式，就表示定义了一个参数。其中type:可以省略，它可以是int等类型。而
int将自动转化为 <tt class="docutils literal"><span class="pre">\d+</span></tt> 这种形式的正则式。Uliweb内置了象: int, float, path, any, string等类型，你可以在 <a class="reference external" href="url_mapping">URL Mapping</a> 文档中了解更多的细节。如果你只定义了
<tt class="docutils literal"><span class="pre">&lt;name&gt;</span></tt> 这种形式，它表示匹配 <tt class="docutils literal"><span class="pre">//</span></tt> 间的内容。一旦在URL中定义了参数，则需要
在View函数中也需要定义相应的参数，因此del_comment函数就写为了： <tt class="docutils literal"><span class="pre">del_comment(id)</span></tt> 。
这里的id与URL中的id是一样的。</p>
<p>好了，现在你可以试一试删除功能是否可用了。</p>
</div>
<div class="section" id="id11">
<h3>出错页面<a class="headerlink" href="#id11" title="永久链接至标题">¶</a></h3>
<p>当程序出错时，你可能需要向用户提示一个错误信息，因此可以使用error()方法来返回一个出错
的页面。它的前面不需要return。只需要一个出错信息就可以了。</p>
<p>那么出错信息的模板怎么定义呢？在你的templates目录下定义一个名为error.html的文件，并加
入一些内容即可。</p>
<p>创建error.html，然后，输入如下代码:</p>
<div class="highlight-python"><pre>{{extend "base.html"}}
{{block title}}Error{{end}}
{{block header}}&lt;h1&gt;Error!&lt;/h1&gt;{{end}}
{{block content}}
&lt;p&gt;{{=message}}&lt;/p&gt;
{{end}}</pre>
</div>
<p>这个页面很简单，就是覆盖了一些block的定义。如title, header, content。</p>
</div>
</div>
<div class="section" id="id12">
<h2>运行<a class="headerlink" href="#id12" title="永久链接至标题">¶</a></h2>
<p>在前面的开发过程中你可以启动一个开发服务器进行调试。启动开发服务器的命令为:</p>
<div class="highlight-python"><pre>uliweb runserver</pre>
</div>
<p>当启动后，在浏览器输入： <tt class="docutils literal"><span class="pre">http://localhost:8000/</span></tt></p>
</div>
<div class="section" id="id13">
<h2>结论<a class="headerlink" href="#id13" title="永久链接至标题">¶</a></h2>
<p>经过学习，我们了解了许多内容：</p>
<ol class="arabic simple">
<li>ORM的使用，包括：ORM的初始化配置，Model的定义，简单的增加，删除，查询</li>
<li>Form使用，包括：Form的定义，Form的布局，HTML代码生成，数据校验，出错处理</li>
<li>模板的使用，包括： {{extend}} 的使用，在模板环境中增加自定义函数，子模板变量定义的
技巧，错误模板的使用，Python代码的嵌入</li>
<li>View的使用，包括：redirect, error的使用, 静态文件处理</li>
<li>URL映射的使用，包括：expose的使用，参数定义，与View函数的对应</li>
<li>结构的了解，包括：Uliweb的app组织，settings.ini的简单使用，view函数与模板文件
的对应关系</li>
</ol>
<p>这里演示的View的处理还是基于函数的方式 ，在另一篇 <a class="reference external" href="basic.html">Simple Todo (Uliweb 版本) 之 基础篇</a>
中有如何使用Class方式的View。</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">內容目录</a></h3>
  <ul>
<li><a class="reference internal" href="#">迷你留言板</a><ul>
<li><a class="reference internal" href="#id2">准备</a></li>
<li><a class="reference internal" href="#id3">创建工程</a></li>
<li><a class="reference internal" href="#app">创建APP</a></li>
<li><a class="reference internal" href="#id4">配置数据库</a></li>
<li><a class="reference internal" href="#id5">模板环境的扩展</a></li>
<li><a class="reference internal" href="#model">准备Model</a></li>
<li><a class="reference internal" href="#id6">静态文件处理</a></li>
<li><a class="reference internal" href="#id7">显示留言</a><ul>
<li><a class="reference internal" href="#guestbook-view">增加guestbook()的View方法</a></li>
<li><a class="reference internal" href="#index-html">定义index.html模板</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id8">增加留言</a><ul>
<li><a class="reference internal" href="#new-comment-view">增加new_comment()的View方法</a></li>
<li><a class="reference internal" href="#id9">定义录入表单</a></li>
<li><a class="reference internal" href="#new-comment-html">编写new_comment.html模板文件</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id10">删除留言</a><ul>
<li><a class="reference internal" href="#url">URL参数定义</a></li>
<li><a class="reference internal" href="#id11">出错页面</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id12">运行</a></li>
<li><a class="reference internal" href="#id13">结论</a></li>
</ul>
</li>
</ul>

  <h4>上一个主题</h4>
  <p class="topless"><a href="hello_uliweb.html"
                        title="上一章">Hello, Uliweb</a></p>
  <h4>下一个主题</h4>
  <p class="topless"><a href="sae.html"
                        title="下一章">Sina Application Engine部署及开发指南</a></p>
  <h3>本页</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/guestbook.txt"
           rel="nofollow">显示源代码</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>快速搜索</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="搜索" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    输入相关的模块，术语，类或者函数名称进行搜索
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="总目录"
             >索引</a></li>
        <li class="right" >
          <a href="sae.html" title="Sina Application Engine部署及开发指南"
             >下一页</a> |</li>
        <li class="right" >
          <a href="hello_uliweb.html" title="Hello, Uliweb"
             >上一页</a> |</li>
        <li><a href="index.html">Uliweb Documentation 0.1.4 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; 版权所有 2012, limodou.
      使用 <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>